# 智能上下文

### 这是什么？

智能上下文是 SillyTavern 扩展，它使用 [ChromaDB 向量数据库](https://www.trychroma.com) 为您的 AI 角色聊天提供聊天历史上下文限制之外的历史信息。

### 这有什么用？

如果你有一个非常长的聊天记录，大部分聊天内容都在通常的 AI 模型上下文限制之外，因此当 AI 编写回复时这些聊天记录无法使用。

智能上下文自动将整个聊天文件的历史记录放入向量数据库中。每次您输入新聊天内容时会搜索向量数据库，如果找到具有匹配关键字的历史消息，则这些聊天消息将被放置到上下文中，以便 AI 在编写其下一个回复时可以看到它们。

***

### 设置说明

1. 将 SillyTavern 版本升级至 1.6.0 或以上。
2. 安装或升级 [Extras](https://github.com/SillyTavern/SillyTavern-extras) 到最新版本。
3. 使用 Pip 安装 Extras 的 requirements-complete.txt (即使您在以前的安装中做过一次)。
4. 运行 Extras 并启用 chromadb 向量数据库模块: `python server.py --enable-modules=chromadb`

#### 安装ChromaDB时出错？

```
ERROR: Could not build wheels for hnswlib, which is required to install pyproject.toml-based projects
```

安装chromadb封装需要以下之一：

- Have Visual C++ build tools installed: <https://visualstudio.microsoft.com/visual-cpp-build-tools/>
- Installing hnswlib from conda: `conda install -c conda-forge hnswlib`

***

### 设置

启用智能上下文后，您应该在 SillyTavern 中进行配置。
智能上下文配置可以在扩展菜单中完成。 ![STExtensionMenuIcon](https://github.com/SillyTavern/SillyTavern/assets/124905043/4545037e-dff8-4373-9513-cddb69780be1)

![Smart Context Config Panel](https://files.catbox.moe/32qexu.png)

有 4 个主要概念需要注意：

- 聊天记录保存
- 内存注入量
- 单个内存长度
- 注入策略

***

#### 智能上下文只有在聊天记录中有 10 条消息后才会启动。

- 在新聊天开始时，ChromaDB 处于非活动状态。
- 一旦聊天累积了 10 条消息，它将开始记录所有消息到数据库中，并在需要时回忆这些消息。

#### 聊天记录保存 ('保留的消息')

默认情况下，ChromaDB 将保留设置中指定的最近聊天历史消息数量。
超出此数量的任何消息都将从您发送的提示中删除，如果数据库中存在“记忆”，则它们将替换旧的聊天历史记录消息（请参见下面的策略）。

***

#### 内存注入量

智能上下文将插入到聊天消息中的'记忆'最大数量。
并非每次插入尝试都会得到这个完整的数量。
如果您发送“狗”相关的消息，并且数据库中只有另一条消息与狗有关，则只会插入1个项目。

***

#### 个人记忆长度

这是每个注入的'记忆'允许的最大长度。
这是以**字符**为单位（而不是 Tokens）。
如果设置得太小，可能会被截断。

例如:

`Ross: I like dogs with long fur and fluffy tails. I dislike dogs with short fur and short tails.`

此数据库'内存'长度为103个字符，因此您需要至少设置为'103'，才能将其完全加入上下文。
如果滑块小于103，则消息将被截断并插入。

***

### 插入策略

#### 替换最老的历史记录

这个策略保留了最近的 X 条消息，删除之前的所有消息，并用'记忆'替换它们。

优点

- 不太可能超出上下文限制
- 存在于上下文顶部附近的记忆将减少对响应的直接影响，同时仍然提供'背景信息'。

缺点

- 旧消息直接插入到聊天记录中，没有特殊的标记，并且通常与保存的自然聊天历史消息没有直接关联，这可能会让较不智能的AI模型感到困惑。

#### 添加到底部

这种策略保留了聊天记录的自然状态，并在格式化的[括号标题]内部添加'记忆'。

这意味着'保留消息'设置被禁用。

优点

- 不缩短或更改当前自然的聊天历史记录
- '记忆'存在于聊天之后，并对下一个AI响应产生更强的影响。

缺点

- 因为没有聊天项目被移除/替换，所以你溢出上下文限制的可能性更高。
- 因为这些记忆非常接近提示的结尾，它们对AI的响应会产生太大影响。

#### 自定义深度

这种策略保留了聊天记录的自然状态，并在您指定的模板中确定深度添加'记忆'。

这意味着'保留消息'设置被禁用。

自定义注入消息应包括 `{{memories}}` 模板词，所有查询到的回忆都将放置在此处。

优点

- 灵活性以进行内存放置实验
- 在上下文中自定义介绍内存

缺点

- 由于没有删除/替换任何聊天项目，您的上下文限制可能会更容易超出。


#### 使用策略

注意：这与“添加到底部”策略不兼容，该策略根本不会删除任何消息。

在使用'替换最旧的历史记录'策略时，勾选此框将启用滑块以选择要替换为智能上下文记忆的上下文聊天历史记录的百分比。它还将禁用手动选择消息数量的两个滑块。

该策略自动计算要替换为智能上下文记忆的聊天历史记录百分比，而不是固定数量的消息。

优点

- 比手动计算消息数量更容易
- 根据可用的上下文大小进行调整，将相同的百分比应用于小型和大型提示空间

缺点

- 删除多少历史记录的计算可能会有些不准确，因为它们基于每条消息的估计令牌数。
- 它将要删除的消息数量四舍五入到最接近 5（0、5、10、15、20等）的数字，因此它不像手动数字选择那样细粒度。

***

### 记忆召回策略

#### 仅从此聊天中回忆

这是智能上下文的默认行为，并仅从 ChromaDB 集合中提取'记忆'以供此特定聊天使用。

#### 从所有角色聊天中回忆起。

这是智能上下文的实验性行为，它从所选角色的所有 ChromaDB 集合中提取“记忆”。

假设这应该允许开发一个更强大的记忆集，跨越许多互动。

建议使用'添加到底部'或'自定义深度'策略，并将'保留消息'的数量设置为较低值，以便 ChromaDB 尽早从内存中提取。

### 使用智能上下文。

一旦启用并配置好，智能上下文将自动运行。

ChromaDB 为 SillyTavern 中打开的每个聊天创建一个新数据库。

该数据库会自动填充整个聊天历史记录。

您还可以手动将文本文件插入到数据库中。

这些文本文件不必是聊天记录。它们可以是任何东西（维基百科条目、同人小说等）。

#### 清除数据库

你可以使用 '清除数据库' 按钮来清除当前聊天的数据库。

如果您发现存储了不准确的记忆（例如您已经删除或编辑过的聊天消息），这将会很有帮助。

***

### FAQ

#### 当我聊天结束后，数据库会发生什么？我可以保存它们吗？

对于本地安装的 Extras 服务器，智能上下文会保存数据库。在通常的使用情况下，没有必要手动保存它们。

对于 Colab 用户，在 Extras 服务关闭时，数据库将被清除。使用导出按钮将数据库保存为 JSON 文件，并在下次想要使用它时进行导入。

**通常情况下，不需要保存智能上下文数据库。**

目前我们有一个导入/导出功能，可以让您保存聊天的数据库并在以后再次使用。

#### 我可以建立一个大数据库，用于参考所有我的聊天记录吗？

这不是智能上下文能力的好用途。
我们建议使用 World Info 来实现此目的。
